# GoThrottle Architecture Diagram

## System Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         Client Requests                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      GoThrottle Proxy                            â”‚
â”‚                        (Port 8080)                               â”‚
â”‚                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚                   Gin Router                               â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                              â”‚                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚            Recovery Middleware (Panic Recovery)            â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                              â”‚                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚         Logging Middleware (Request Logging)               â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                              â”‚                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚      RateLimit Middleware (Token Bucket Check)             â”‚ â”‚
â”‚  â”‚                                                             â”‚ â”‚
â”‚  â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚ â”‚
â”‚  â”‚   â”‚         Per-Client Storage                       â”‚     â”‚ â”‚
â”‚  â”‚   â”‚                                                  â”‚     â”‚ â”‚
â”‚  â”‚   â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚     â”‚ â”‚
â”‚  â”‚   â”‚  â”‚ 192.168.1.1â”‚  â”‚ 192.168.1.2â”‚  â”‚10.0.0.100 â”‚ â”‚     â”‚ â”‚
â”‚  â”‚   â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”  â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”  â”‚ â”‚     â”‚ â”‚
â”‚  â”‚   â”‚  â”‚  â”‚Bucketâ”‚  â”‚  â”‚  â”‚Bucketâ”‚  â”‚  â”‚ â”‚Bucketâ”‚  â”‚ â”‚     â”‚ â”‚
â”‚  â”‚   â”‚  â”‚  â”‚ ğŸª£   â”‚  â”‚  â”‚  â”‚ ğŸª£   â”‚  â”‚  â”‚ â”‚ ğŸª£   â”‚  â”‚ â”‚     â”‚ â”‚
â”‚  â”‚   â”‚  â”‚  â”‚ â—â—â—  â”‚  â”‚  â”‚  â”‚ â—â—â—â—â—â”‚  â”‚  â”‚ â”‚ â—â—   â”‚  â”‚ â”‚     â”‚ â”‚
â”‚  â”‚   â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”˜  â”‚ â”‚     â”‚ â”‚
â”‚  â”‚   â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚     â”‚ â”‚
â”‚  â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚ â”‚
â”‚  â”‚                                                             â”‚ â”‚
â”‚  â”‚   Allow? âœ… â†’ Continue    Deny? âŒ â†’ HTTP 429              â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                              â”‚                                   â”‚
â”‚                              â–¼ (if allowed)                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚                Proxy Handler (Route Matching)               â”‚ â”‚
â”‚  â”‚                                                              â”‚ â”‚
â”‚  â”‚   Route Table:                                               â”‚ â”‚
â”‚  â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚ â”‚
â”‚  â”‚   â”‚ /api    â†’ http://localhost:8000                  â”‚     â”‚ â”‚
â”‚  â”‚   â”‚ /api/v2 â†’ http://localhost:9000                  â”‚     â”‚ â”‚
â”‚  â”‚   â”‚ /auth   â†’ http://localhost:8001                  â”‚     â”‚ â”‚
â”‚  â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚ â”‚
â”‚  â”‚                                                              â”‚ â”‚
â”‚  â”‚   Matching: Longest Prefix                                  â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                              â”‚                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                               â”‚
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚                â”‚                â”‚
              â–¼                â–¼                â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  API Backend    â”‚ â”‚Auth Service â”‚ â”‚Other Serviceâ”‚
    â”‚  localhost:8000 â”‚ â”‚localhost:9000â”‚ â”‚localhost:8001â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Token Bucket Algorithm

```
                   Token Bucket (Per Client)
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚  Maximum: burst (e.g., 10)  â”‚
              â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
              â”‚                             â”‚
              â”‚         ğŸª™ ğŸª™ ğŸª™           â”‚  â† Current tokens
              â”‚                             â”‚
              â”‚                             â”‚
              â”‚                             â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚      â–²
                        â”‚      â”‚
          Request       â”‚      â”‚  Refill
         consumes 1 â”€â”€â”€â”€â”˜      â””â”€â”€ requests_per_second
          token                   (continuous)


Timeline:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º
t=0s         t=1s         t=2s         t=3s
â”‚            â”‚            â”‚            â”‚
â”œâ”€10 tokens  â”œâ”€15 tokens  â”œâ”€20 tokens  â”œâ”€25 tokens
â”‚ (initial)  â”‚ (+5)       â”‚ (+5)       â”‚ (+5)
â”‚            â”‚            â”‚            â”‚
â””â”€ make 10   â””â”€ capped    â””â”€ capped    â””â”€ capped
   requests     at 10        at 10        at 10
   â†’ 0 left     tokens       tokens       tokens
```

## Request Flow Examples

### Example 1: Successful Request
```
1. Client (192.168.1.1) â†’ GET /api/users
2. RateLimit Middleware checks bucket â†’ 5 tokens available âœ…
3. Consume 1 token â†’ 4 tokens left
4. Proxy Handler matches /api â†’ http://localhost:8000
5. Forward request â†’ http://localhost:8000/api/users
6. Return response â†’ 200 OK
```

### Example 2: Rate Limited Request
```
1. Client (192.168.1.1) â†’ GET /api/users
2. RateLimit Middleware checks bucket â†’ 0 tokens âŒ
3. Return â†’ 429 Too Many Requests
   Headers: Retry-After: 1
4. Request NOT forwarded to backend
```

### Example 3: Multiple Clients
```
Client A (192.168.1.1):
  Bucket A: â—â—â—â—â— (5 tokens)
  
Client B (192.168.1.2):
  Bucket B: â—â—â—â—â—â—â—â—â—â— (10 tokens)
  
Client A exhausts tokens â†’ Client A blocked
Client B still has tokens â†’ Client B continues
```

## Component Dependencies

```
main.go
  â”‚
  â”œâ”€â–º config/loader.go
  â”‚     â””â”€â–º config/config.go
  â”‚
  â”œâ”€â–º middleware/ratelimit.go
  â”‚     â””â”€â–º ratelimit/storage.go
  â”‚           â””â”€â–º ratelimit/limiter.go
  â”‚
  â”œâ”€â–º middleware/logging.go
  â”‚
  â””â”€â–º proxy/proxy.go
        â””â”€â–º proxy/balancer.go
```

## Configuration Flow

```
configs/config.yaml
        â”‚
        â–¼
   config.Load()
        â”‚
        â”œâ”€â–º Validate
        â”‚     â””â”€ Check routes exist
        â”‚     â””â”€ Check rate limits > 0
        â”‚     â””â”€ Check valid URLs
        â”‚
        â”œâ”€â–º Set Defaults
        â”‚     â””â”€ port = 8080 (if not set)
        â”‚
        â””â”€â–º Return Config struct
              â”‚
              â”œâ”€â–º Initialize RateLimiter
              â”œâ”€â–º Initialize ProxyHandler
              â””â”€â–º Start Server
```

## File Organization

```
gothrottle/
â”œâ”€â”€ cmd/
â”‚   â””â”€â”€ proxy/
â”‚       â””â”€â”€ main.go                 â† Entry point
â”‚
â”œâ”€â”€ configs/
â”‚   â””â”€â”€ config.yaml                 â† Configuration
â”‚
â”œâ”€â”€ internal/
â”‚   â”œâ”€â”€ config/                     â† Config management
â”‚   â”‚   â”œâ”€â”€ config.go
â”‚   â”‚   â”œâ”€â”€ loader.go
â”‚   â”‚   â””â”€â”€ loader_test.go
â”‚   â”‚
â”‚   â”œâ”€â”€ middleware/                 â† HTTP middleware
â”‚   â”‚   â”œâ”€â”€ logging.go
â”‚   â”‚   â”œâ”€â”€ ratelimit.go
â”‚   â”‚   â””â”€â”€ ratelimit_test.go
â”‚   â”‚
â”‚   â”œâ”€â”€ proxy/                      â† Reverse proxy
â”‚   â”‚   â”œâ”€â”€ balancer.go
â”‚   â”‚   â”œâ”€â”€ proxy.go
â”‚   â”‚   â””â”€â”€ proxy_test.go
â”‚   â”‚
â”‚   â””â”€â”€ ratelimit/                  â† Rate limiting logic
â”‚       â”œâ”€â”€ limiter.go
â”‚       â”œâ”€â”€ limiter_test.go
â”‚       â”œâ”€â”€ storage.go
â”‚       â””â”€â”€ storage_test.go
â”‚
â”œâ”€â”€ bin/                            â† Build output
â”‚   â””â”€â”€ proxy
â”‚
â”œâ”€â”€ demo.sh                         â† Demo script
â”œâ”€â”€ test.sh                         â† Test script
â”œâ”€â”€ README.md                       â† User documentation
â”œâ”€â”€ IMPLEMENTATION.md               â† Implementation details
â””â”€â”€ go.mod                          â† Dependencies
```

## Testing Strategy

```
Unit Tests
  â”‚
  â”œâ”€â–º config/loader_test.go
  â”‚     â””â”€ Test YAML loading
  â”‚     â””â”€ Test validation
  â”‚     â””â”€ Test defaults
  â”‚
  â”œâ”€â–º ratelimit/limiter_test.go
  â”‚     â””â”€ Test token consumption
  â”‚     â””â”€ Test refill
  â”‚     â””â”€ Test burst
  â”‚     â””â”€ Test concurrency
  â”‚
  â”œâ”€â–º ratelimit/storage_test.go
  â”‚     â””â”€ Test per-client buckets
  â”‚     â””â”€ Test isolation
  â”‚     â””â”€ Test concurrency
  â”‚
  â”œâ”€â–º proxy/proxy_test.go
  â”‚     â””â”€ Test route matching
  â”‚     â””â”€ Test longest prefix
  â”‚     â””â”€ Test forwarding
  â”‚
  â””â”€â–º middleware/ratelimit_test.go
        â””â”€ Test HTTP 429 response
        â””â”€ Test headers
        â””â”€ Test request blocking
```
